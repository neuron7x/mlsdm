name: Benchmark Comparison

on:
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'scripts/ci/**'

jobs:
  compare:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Run baseline benchmark (main)
        run: |
          git checkout main
          make bench > baseline.txt

      - name: Run PR benchmark
        run: |
          git checkout ${{ github.head_ref }}
          make bench > pr.txt

      - name: Compare results
        run: |
          python scripts/benchmark_diff.py baseline.txt pr.txt \
            --threshold 0.1 \
            --output benchmark-comparison.md

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('benchmark-comparison.md', 'utf8');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
