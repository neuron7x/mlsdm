name: Dependency Check

on:
  pull_request:
    paths:
      - 'pyproject.toml'
      - 'requirements.txt'
      - 'requirements-dev.txt'
      - '.github/workflows/dependency-check.yml'
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'
      - 'requirements.txt'
      - 'requirements-dev.txt'

permissions:
  contents: read

jobs:
  check-requirements-sync:
    name: Check Requirements Sync
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools>=7.4.0

      - name: Generate requirements.txt from pyproject.toml
        run: |
          pip-compile pyproject.toml --generate-hashes --output-file=requirements.txt.new --quiet

      - name: Generate requirements-dev.txt from pyproject.toml
        run: |
          pip-compile pyproject.toml --extra=dev --generate-hashes --output-file=requirements-dev.txt.new --quiet
        continue-on-error: true  # requirements-dev.txt might not exist yet

      - name: Check if requirements.txt is up-to-date
        run: |
          if [ ! -f requirements.txt ]; then
            echo "❌ requirements.txt does not exist. Run 'make lock-deps' to generate it."
            exit 1
          fi

          # Compare generated with committed (ignoring whitespace and comments about generation time)
          if ! diff -u --ignore-blank-lines \
            <(grep -v "^# This file is autogenerated by pip-compile" requirements.txt | grep -v "^#   pip-compile" | grep -v "^# via " ) \
            <(grep -v "^# This file is autogenerated by pip-compile" requirements.txt.new | grep -v "^#   pip-compile" | grep -v "^# via ") ; then
            echo ""
            echo "❌ requirements.txt is out of sync with pyproject.toml"
            echo ""
            echo "To fix this:"
            echo "  1. Install pip-tools: pip install pip-tools"
            echo "  2. Run: make lock-deps"
            echo "  3. Commit the updated requirements.txt and requirements-dev.txt"
            exit 1
          fi

          echo "✅ requirements.txt is up-to-date"

      - name: Check if requirements-dev.txt is up-to-date
        if: hashFiles('requirements-dev.txt') != ''
        run: |
          # Compare generated with committed (ignoring whitespace and comments about generation time)
          if ! diff -u --ignore-blank-lines \
            <(grep -v "^# This file is autogenerated by pip-compile" requirements-dev.txt | grep -v "^#   pip-compile" | grep -v "^# via ") \
            <(grep -v "^# This file is autogenerated by pip-compile" requirements-dev.txt.new | grep -v "^#   pip-compile" | grep -v "^# via ") ; then
            echo ""
            echo "❌ requirements-dev.txt is out of sync with pyproject.toml"
            echo ""
            echo "To fix this:"
            echo "  1. Install pip-tools: pip install pip-tools"
            echo "  2. Run: make lock-deps"
            echo "  3. Commit the updated requirements.txt and requirements-dev.txt"
            exit 1
          fi

          echo "✅ requirements-dev.txt is up-to-date"
        continue-on-error: true  # Don't fail if requirements-dev.txt doesn't exist yet

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: check-requirements-sync

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies for audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit on requirements.txt
        run: |
          pip-audit --requirement requirements.txt --desc
        continue-on-error: true  # Don't fail build on audit issues, just report

      - name: Check for critical vulnerabilities
        run: |
          # Fail only on HIGH or CRITICAL vulnerabilities
          if pip-audit --requirement requirements.txt --desc 2>&1 | grep -iE "(critical|high)" ; then
            echo "❌ Critical or high severity vulnerabilities found"
            exit 1
          fi
          echo "✅ No critical or high severity vulnerabilities found"
