name: Adversarial Tests

on:
  schedule:
    # Run weekly on Sundays at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  adversarial-testing:
    name: Adversarial ML Testing
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run jailbreak resistance tests
        id: jailbreak_tests
        run: |
          echo "Running jailbreak resistance tests..."
          pytest tests/adversarial/test_jailbreak_resistance.py -v -s --tb=short \
            | tee jailbreak_results.txt
      
      - name: Run prompt injection tests
        id: injection_tests
        run: |
          echo "Running prompt injection tests..."
          pytest tests/adversarial/test_prompt_injection.py -v -s --tb=short \
            | tee injection_results.txt
      
      - name: Run threshold manipulation tests
        id: threshold_tests
        run: |
          echo "Running threshold manipulation tests..."
          pytest tests/adversarial/test_moral_threshold_attack.py -v -s --tb=short \
            | tee threshold_results.txt
      
      - name: Run embedding poisoning tests
        id: embedding_tests
        run: |
          echo "Running embedding poisoning tests..."
          pytest tests/adversarial/test_embedding_poisoning.py -v -s --tb=short \
            | tee embedding_results.txt
      
      - name: Generate summary report
        if: always()
        run: |
          echo "# Adversarial Testing Summary" > adversarial_summary.md
          echo "" >> adversarial_summary.md
          echo "## Test Results" >> adversarial_summary.md
          echo "" >> adversarial_summary.md
          
          echo "### Jailbreak Resistance" >> adversarial_summary.md
          grep -A 5 "Jailbreak Resistance Test Results" jailbreak_results.txt >> adversarial_summary.md || echo "No results found" >> adversarial_summary.md
          echo "" >> adversarial_summary.md
          
          echo "### Prompt Injection" >> adversarial_summary.md
          grep "Injection Resistance" injection_results.txt >> adversarial_summary.md || echo "No results found" >> adversarial_summary.md
          echo "" >> adversarial_summary.md
          
          echo "### Threshold Manipulation" >> adversarial_summary.md
          grep -E "passed|failed" threshold_results.txt | head -10 >> adversarial_summary.md || echo "No results found" >> adversarial_summary.md
          echo "" >> adversarial_summary.md
          
          cat adversarial_summary.md
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: adversarial-test-results
          path: |
            *_results.txt
            adversarial_summary.md
          retention-days: 90
      
      - name: Check adversarial resistance thresholds
        run: |
          echo "Checking adversarial resistance metrics..."
          
          # Check jailbreak success rate
          if grep -q "exceeds threshold" jailbreak_results.txt; then
            echo "❌ Jailbreak success rate exceeds threshold"
            exit 1
          fi
          
          # Check injection success rate
          if grep -q "exceeds threshold" injection_results.txt; then
            echo "❌ Injection success rate exceeds threshold"
            exit 1
          fi
          
          # Check threshold drift
          if grep -q "exceeds max" threshold_results.txt; then
            echo "❌ Threshold drift exceeds maximum"
            exit 1
          fi
          
          echo "✅ All adversarial resistance metrics within thresholds"
      
      - name: Create issue on threshold violation
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Adversarial Testing: Threshold Violation Detected',
              body: 'Adversarial testing detected threshold violations. This indicates potential security vulnerabilities.\n\n**Action Required**: Review the workflow artifacts and address any bypassed attacks or excessive drift.\n\nWorkflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n**Key Metrics:**\n- Jailbreak success rate target: <0.5%\n- Injection success rate target: <1%\n- Threshold drift max: ≤0.15',
              labels: ['security', 'adversarial-test', 'urgent']
            })
