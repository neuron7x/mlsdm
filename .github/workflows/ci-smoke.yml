name: CI Smoke Tests

on:
  push:
    branches:
      - main
      - 'feature/*'
  pull_request:
    branches:
      - main
      - 'feature/*'

permissions:
  contents: read

jobs:
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Guard against hidden/bidirectional Unicode
        run: python scripts/check_bidi.py

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install uv
        run: |
          python -m pip install --upgrade pip uv

      - name: Dependency drift check
        run: |
          uv export --locked --no-hashes --format requirements-txt --extra test --extra dev --output-file /tmp/req_from_uv.txt
          diff -u requirements.txt /tmp/req_from_uv.txt

      - name: Install dependencies
        run: |
          uv sync --frozen --extra test --extra dev

      - name: Validate defusedxml availability
        run: |
          uv run python - <<'PY'
          import importlib
          importlib.import_module("defusedxml.ElementTree")
          print("defusedxml import ok")
          PY

      - name: Run smoke tests (fast unit tests only)
        run: |
          mkdir -p artifacts
          # Run all unit tests except slow ones for fast feedback
          # The 'slow' marker is already defined and used in the codebase
          # This gives us fast feedback on basic functionality
          uv run pytest tests/unit/ -v -m "not slow" --tb=short -q --maxfail=5 --junitxml=artifacts/junit-smoke.xml
        timeout-minutes: 3

      - name: Upload smoke junit report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: smoke-junit
          path: artifacts/junit-smoke.xml
          retention-days: 7

      - name: Run critical module imports
        run: |
          uv run python -c "
          print('Testing critical imports...')
          from mlsdm.core.cognitive_controller import CognitiveController
          from mlsdm.engine.neuro_cognitive_engine import NeuroCognitiveEngine
          from mlsdm.api.middleware import BulkheadMiddleware, TimeoutMiddleware
          from mlsdm.security.rbac import RBACMiddleware, Role, RoleValidator
          from mlsdm.observability.logger import ObservabilityLogger
          from mlsdm.observability.metrics import MetricsExporter
          print('✓ All critical imports successful')
          "

      - name: Validate configuration files
        run: |
          uv run python -c "
          import yaml
          import os

          config_files = [
              'config/default_config.yaml',
          ]

          for config_file in config_files:
              if os.path.exists(config_file):
                  with open(config_file) as f:
                      yaml.safe_load(f)
                  print(f'✓ {config_file} is valid YAML')
              else:
                  print(f'⚠ {config_file} not found (optional)')
          "

  coverage-gate:
    name: Coverage Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip uv
          uv sync --frozen --extra test --extra dev

      - name: Run coverage gate
        run: uv run ./coverage_gate.sh
        env:
          COVERAGE_MIN: 75  # Staged target: 65% -> 75% -> 85% -> 90%

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30

  ablation-smoke:
    name: Ablation Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip uv
          uv sync --frozen --extra test --extra dev

      - name: Run ablation baseline smoke test
        run: |
          uv run python scripts/eval/run_ablation.py --mode baseline --seed 42
        timeout-minutes: 1

      - name: Run ablation tests
        run: |
          uv run pytest tests/eval/test_ablation_runner.py -v --tb=short -q
        timeout-minutes: 2

      - name: Upload ablation report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ablation-report
          path: reports/ablation/*.json
          retention-days: 30

  policy-check:
    name: Policy Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install conftest
        run: |
          curl -L -o conftest.tar.gz --fail --retry 3 \
            https://github.com/open-policy-agent/conftest/releases/download/v0.55.0/conftest_0.55.0_Linux_x86_64.tar.gz
          tar -xzf conftest.tar.gz
          chmod +x conftest
          sudo mv conftest /usr/local/bin/
          rm conftest.tar.gz

      - name: Run policy checks on CI workflows
        run: |
          echo "Checking CI workflow policies..."
          # Use --fail-on-warn=false to allow warnings but fail on denies
          conftest test .github/workflows/*.yml -p policies/ci/ --all-namespaces --fail-on-warn=false

  failure-intelligence:
    name: Failure Intelligence
    needs:
      - smoke
      - coverage-gate
      - ablation-smoke
      - policy-check
    if: ${{ always() }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      FI_JUNIT_ARTIFACT: smoke-junit
      FI_JUNIT_PATH: artifacts/junit-smoke.xml
      FI_COV_ARTIFACT: coverage-report
      FI_COV_PATH: artifacts/coverage.xml
      FI_ABLATION_ARTIFACT: ablation-report
      FI_ABLATION_PATH: artifacts/ablation/*.json
      FI_CHANGED_FILES_PATH: changed_files.txt
      FI_SUMMARY_MD: failure_summary.md
      FI_SUMMARY_JSON: failure_summary.json

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            .venv
          key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip uv
          uv sync --frozen

      - name: Determine changed files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            git fetch origin "${{ github.event.pull_request.base.ref }}" --depth=1
          else
            BASE_REF="${{ github.ref_name }}"
          fi
          echo "BASE_REF=$BASE_REF" >> "$GITHUB_ENV"
          git diff --name-only origin/"$BASE_REF"...HEAD > "$FI_CHANGED_FILES_PATH" || true
          if [ ! -s "$FI_CHANGED_FILES_PATH" ]; then
            git diff --name-only HEAD~1...HEAD > "$FI_CHANGED_FILES_PATH" || true
          fi

      - name: Download smoke junit
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.FI_JUNIT_ARTIFACT }}
          path: artifacts
        continue-on-error: true

      - name: Download coverage report
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.FI_COV_ARTIFACT }}
          path: artifacts
        continue-on-error: true

      - name: Download ablation report
        uses: actions/download-artifact@v6
        with:
          name: ${{ env.FI_ABLATION_ARTIFACT }}
          path: artifacts
        continue-on-error: true

      - name: Validate expected artifacts
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          expected = [
              ("artifact_missing", os.environ["FI_JUNIT_ARTIFACT"], os.environ["FI_JUNIT_PATH"]),
              ("artifact_missing", os.environ["FI_COV_ARTIFACT"], os.environ["FI_COV_PATH"]),
              ("input_missing", "changed_files", os.environ["FI_CHANGED_FILES_PATH"]),
          ]
          missing = []
          for code, artifact, path in expected:
              if not Path(path).exists():
                  missing.append({"code": code, "artifact": artifact, "path": path})

          if not missing:
              raise SystemExit(0)

          summary = {
              "status": "degraded",
              "signal": "Failure intelligence inputs missing",
              "errors": missing,
              "input_integrity": missing,
          }
          Path(os.environ["FI_SUMMARY_JSON"]).write_text(json.dumps(summary, indent=2), encoding="utf-8")
          md_lines = ["## Failure Intelligence", "", "Inputs missing for failure intelligence:"]
          md_lines.extend([f"- {item['code']}: {item['artifact']} ({item['path'] or 'missing'})" for item in missing])
          Path(os.environ["FI_SUMMARY_MD"]).write_text("\n".join(md_lines), encoding="utf-8")
          PY

      - name: Generate failure intelligence summary
        if: always()
        run: |
          uv run python scripts/ci/failure_intelligence.py \
            --junit "$FI_JUNIT_PATH" \
            --coverage "$FI_COV_PATH" \
            --changed-files "$FI_CHANGED_FILES_PATH" \
            --out "$FI_SUMMARY_MD" \
            --json "$FI_SUMMARY_JSON"

      - name: Publish job summary
        if: always()
        run: |
          if [[ -f "$FI_SUMMARY_MD" ]]; then
            cat "$FI_SUMMARY_MD" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Failure Intelligence produced no summary file." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload failure intelligence artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: failure-intelligence
          path: |
            ${{ env.FI_SUMMARY_MD }}
            ${{ env.FI_SUMMARY_JSON }}
            ${{ env.FI_CHANGED_FILES_PATH }}
          retention-days: 7
