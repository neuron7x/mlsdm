name: CI Smoke Tests

on:
  push:
    branches:
      - main
      - 'feature/*'
  pull_request:
    branches:
      - main
      - 'feature/*'

permissions:
  contents: read

jobs:
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11 with uv
        uses: astral-sh/uv-action@v3
        with:
          python-version: '3.11'
          enable-cache: true

      - name: Sync dependencies from lockfile
        run: uv sync --all-extras --frozen

      - name: Run smoke tests (fast unit tests only)
        run: |
          uv run pytest tests/unit/ -v -m "not slow" --tb=short -q --maxfail=5
        timeout-minutes: 3

      - name: Run critical module imports
        run: |
          uv run python -c "
          print('Testing critical imports...')
          from mlsdm.core.cognitive_controller import CognitiveController
          from mlsdm.engine.neuro_cognitive_engine import NeuroCognitiveEngine
          from mlsdm.api.middleware import BulkheadMiddleware, TimeoutMiddleware
          from mlsdm.security.rbac import RBACMiddleware, Role, RoleValidator
          from mlsdm.observability.logger import ObservabilityLogger
          from mlsdm.observability.metrics import MetricsExporter
          print('✓ All critical imports successful')
          "

      - name: Validate configuration files
        run: |
          python -c "
          import yaml
          import os

          config_files = [
              'config/default_config.yaml',
          ]

          for config_file in config_files:
              if os.path.exists(config_file):
                  with open(config_file) as f:
                      yaml.safe_load(f)
                  print(f'✓ {config_file} is valid YAML')
              else:
                  print(f'⚠ {config_file} not found (optional)')
          "

  coverage-gate:
    name: Coverage Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11 with uv
        uses: astral-sh/uv-action@v3
        with:
          python-version: '3.11'
          enable-cache: true

      - name: Sync dependencies from lockfile
        run: uv sync --all-extras --frozen

      - name: Run coverage gate
        run: uv run ./coverage_gate.sh
        env:
          COVERAGE_MIN: 65  # Current baseline is ~68%, set gate slightly below

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30

  policy-check:
    name: Policy Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.55.0/conftest_0.55.0_Linux_x86_64.tar.gz | tar xzf -
          chmod +x conftest
          sudo mv conftest /usr/local/bin/

      - name: Run policy checks on CI workflows
        run: |
          echo "Checking CI workflow policies..."
          # Use --fail-on-warn=false to allow warnings but fail on denies
          conftest test .github/workflows/*.yml -p policies/ci/ --all-namespaces --fail-on-warn=false
