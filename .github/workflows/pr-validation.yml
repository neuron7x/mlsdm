name: PR Pre-merge Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check commit message format
        run: |
          git log -1 --pretty=%B | grep -E "^(feat|fix|perf|refactor|test|docs|chore|ci)\(.+\):"

      - name: Verify no TODOs in production code
        run: |
          if rg -n "TODO|FIXME|PLACEHOLDER" src tests .github/workflows; then
            echo "‚ùå TODO/FIXME/PLACEHOLDER found"
            exit 1
          fi

      - name: Lint check (fast)
        run: |
          python -m pip install --upgrade pip
          pip install ruff
          ruff check src tests --select E,F,W

      - name: Syntax validation
        run: |
          python - <<'PY'
          import pathlib
          import py_compile

          for path in pathlib.Path("src").rglob("*.py"):
              py_compile.compile(str(path), doraise=True)
          PY

          python -m pip install yamllint
          yamllint .github/workflows/*.yml
