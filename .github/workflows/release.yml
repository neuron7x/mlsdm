name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Gate 1: Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        python-version: ['3.10', '3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --tb=short

  # Gate 2: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --tb=short

  # Gate 3: Property-Based Tests
  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run property-based tests
        run: |
          pytest tests/property/ -v --tb=short --maxfail=5
        timeout-minutes: 15

  # Gate 4: Validation Tests
  validation-tests:
    name: Validation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run validation tests
        run: |
          pytest tests/validation/ -v --tb=short

  # Gate 5: Security Tests
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run security tests
        run: |
          pytest tests/security/ -v --tb=short

  # Gate 6: Observability Tests
  observability-tests:
    name: Observability Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run observability tests
        run: |
          pytest tests/observability/ -v --tb=short

  # Gate 7: Benchmarks (Performance Gate)
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run benchmarks
        run: |
          mkdir -p reports
          set -o pipefail
          pytest benchmarks/test_neuro_engine_performance.py -v -s --tb=short 2>&1 | tee reports/benchmark-output.log
        timeout-minutes: 10
      - name: Upload benchmark logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-logs
          path: reports/benchmark-output.log

  # Gate 8: Code Quality (Linting + Type Checking)
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[dev]"

      - name: Run linting
        run: make lint

      - name: Run type checking
        run: make type

  # Gate 9: Coverage Check
  coverage-check:
    name: Coverage Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore Python cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.cache/uv
            .venv
          key: ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-${{ hashFiles('**/requirements.txt', '**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-py${{ matrix.python-version || '3.11' }}-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run coverage check
        run: |
          # WHY: Set coverage threshold at 80% - current coverage is ~83-84%
          # This allows for small fluctuations while maintaining quality gate
          pytest --ignore=tests/load --cov=src/mlsdm --cov-report=term-missing --cov-fail-under=80 -q -m "not slow and not benchmark"

  # CICD-008: Changelog Generation
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Extract version from tag
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog from conventional commits
        id: changelog
        run: |
          # Find previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG=${{ steps.get_version.outputs.TAG }}

          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog from $PREV_TAG to $CURRENT_TAG"
            RANGE="$PREV_TAG..HEAD"
          else
            echo "First release - generating changelog from all commits"
            RANGE="HEAD"
          fi

          # Generate changelog grouped by type
          echo "## [${{ steps.get_version.outputs.VERSION }}] - $(date +%Y-%m-%d)" > changelog-fragment.md
          echo "" >> changelog-fragment.md

          # Features
          FEATURES=$(git log $RANGE --pretty=format:"%s" 2>/dev/null | grep -E "^feat(\(.*\))?:" | sed 's/^feat\([^:]*\): /- /' || true)
          if [ -n "$FEATURES" ]; then
            echo "### âœ¨ Features" >> changelog-fragment.md
            echo "$FEATURES" >> changelog-fragment.md
            echo "" >> changelog-fragment.md
          fi

          # Bug fixes
          FIXES=$(git log $RANGE --pretty=format:"%s" 2>/dev/null | grep -E "^fix(\(.*\))?:" | sed 's/^fix\([^:]*\): /- /' || true)
          if [ -n "$FIXES" ]; then
            echo "### ðŸ› Bug Fixes" >> changelog-fragment.md
            echo "$FIXES" >> changelog-fragment.md
            echo "" >> changelog-fragment.md
          fi

          # Documentation
          DOCS=$(git log $RANGE --pretty=format:"%s" 2>/dev/null | grep -E "^docs(\(.*\))?:" | sed 's/^docs\([^:]*\): /- /' || true)
          if [ -n "$DOCS" ]; then
            echo "### ðŸ“š Documentation" >> changelog-fragment.md
            echo "$DOCS" >> changelog-fragment.md
            echo "" >> changelog-fragment.md
          fi

          # Performance
          PERF=$(git log $RANGE --pretty=format:"%s" 2>/dev/null | grep -E "^perf(\(.*\))?:" | sed 's/^perf\([^:]*\): /- /' || true)
          if [ -n "$PERF" ]; then
            echo "### âš¡ Performance" >> changelog-fragment.md
            echo "$PERF" >> changelog-fragment.md
            echo "" >> changelog-fragment.md
          fi

          # Security
          SECURITY=$(git log $RANGE --pretty=format:"%s" 2>/dev/null | grep -E "^(security|sec)(\(.*\))?:" | sed 's/^sec\(urity\)\?\([^:]*\): /- /' || true)
          if [ -n "$SECURITY" ]; then
            echo "### ðŸ”’ Security" >> changelog-fragment.md
            echo "$SECURITY" >> changelog-fragment.md
            echo "" >> changelog-fragment.md
          fi

          # Chores
          CHORES=$(git log $RANGE --pretty=format:"%s" 2>/dev/null | grep -E "^chore(\(.*\))?:" | sed 's/^chore\([^:]*\): /- /' || true)
          if [ -n "$CHORES" ]; then
            echo "### ðŸ”§ Maintenance" >> changelog-fragment.md
            echo "$CHORES" >> changelog-fragment.md
            echo "" >> changelog-fragment.md
          fi

          cat changelog-fragment.md

          # Store for other jobs
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog-fragment.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload changelog fragment
        uses: actions/upload-artifact@v6
        with:
          name: changelog-fragment
          path: changelog-fragment.md
          retention-days: 7

  # Build and Push Docker Image (only after ALL gates pass)
  build-and-push-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs:
      - unit-tests
      - integration-tests
      - property-tests
      - validation-tests
      - security-tests
      - observability-tests
      - benchmarks
      - code-quality
      - coverage-check
      - generate-changelog

    outputs:
      image_digest: ${{ steps.docker_build.outputs.digest }}

    permissions:
      contents: write
      packages: write
      id-token: write  # Required for OIDC cosign signing

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download changelog fragment
        uses: actions/download-artifact@v7
        with:
          name: changelog-fragment
          path: .

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: docker_build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.neuro-engine-service
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/mlsdm-neuro-engine:${{ steps.get_version.outputs.VERSION }}
            ghcr.io/${{ github.repository_owner }}/mlsdm-neuro-engine:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # CICD-006: Container image signing with cosign
      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Sign container image with cosign (OIDC keyless)
        env:
          COSIGN_EXPERIMENTAL: "true"
          DIGEST: ${{ steps.docker_build.outputs.digest }}
        run: |
          echo "Signing image with digest: ${DIGEST}"
          cosign sign --yes ghcr.io/${{ github.repository_owner }}/mlsdm-neuro-engine@${DIGEST}
          echo "âœ… Container image signed successfully"

      # SEC-005: Generate SBOM with syft
      - name: Install syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOM (CycloneDX format)
        run: |
          syft ghcr.io/${{ github.repository_owner }}/mlsdm-neuro-engine:${{ steps.get_version.outputs.VERSION }} \
            -o cyclonedx-json=sbom-cyclonedx.json \
            -o spdx-json=sbom-spdx.json
          echo "âœ… SBOM generated in CycloneDX and SPDX formats"

      - name: Attach SBOM to image with cosign
        env:
          COSIGN_EXPERIMENTAL: "true"
          DIGEST: ${{ steps.docker_build.outputs.digest }}
        run: |
          cosign attach sbom --sbom sbom-cyclonedx.json ghcr.io/${{ github.repository_owner }}/mlsdm-neuro-engine@${DIGEST}
          echo "âœ… SBOM attached to container image"

      # DOC-003: Auto-generate OpenAPI spec
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Generate OpenAPI specification
        run: |
          python scripts/export_openapi.py --output docs/openapi.json
          echo "âœ… OpenAPI specification generated"
        env:
          DISABLE_RATE_LIMIT: "1"

      - name: Create release notes
        run: |
          # Use generated changelog fragment if available, fallback to CHANGELOG.md extraction
          if [ -f "changelog-fragment.md" ]; then
            cp changelog-fragment.md release-notes.md
            echo "" >> release-notes.md
            echo "---" >> release-notes.md
            echo "" >> release-notes.md
            echo "**Assets:**" >> release-notes.md
            echo "- Docker image: \`ghcr.io/neuron7x/mlsdm-neuro-engine:${{ steps.get_version.outputs.VERSION }}\`" >> release-notes.md
            echo "- SBOM (CycloneDX): \`sbom-cyclonedx.json\`" >> release-notes.md
            echo "- SBOM (SPDX): \`sbom-spdx.json\`" >> release-notes.md
            echo "- OpenAPI Spec: \`openapi.json\`" >> release-notes.md
          else
            # Fallback: Extract from CHANGELOG.md
            awk '/^## \['${{ steps.get_version.outputs.VERSION }}'\]/,/^## \[/' CHANGELOG.md | head -n -1 > release-notes.md || echo "Release ${{ steps.get_version.outputs.TAG }}" > release-notes.md
          fi
      - name: Upload release assets
        uses: actions/upload-artifact@v6
        with:
          name: release-assets
          path: |
            sbom-cyclonedx.json
            sbom-spdx.json
            docs/openapi.json
            changelog-fragment.md
            release-notes.md

  # Publish to TestPyPI (after Docker build succeeds)
  publish-to-testpypi:
    name: Publish to TestPyPI
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-and-push-docker
    if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, 'rc') == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          python -m build

      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          # Only publish to TestPyPI if token is configured
          if [ -n "$TWINE_PASSWORD" ]; then
            python -m twine upload --repository testpypi dist/* --verbose
          else
            echo "TEST_PYPI_API_TOKEN not configured, skipping TestPyPI upload"
          fi
        # INFORMATIONAL: TestPyPI publishing is optional and should not block releases
        # The package has already passed all security and quality gates
        continue-on-error: true

  # Security Scan (after Docker build)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-and-push-docker

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/mlsdm-neuro-engine:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on vulnerabilities
        # SECURITY GATE: This scan blocks releases if critical/high vulnerabilities found
        # exit-code: '1' + severity filter ensures non-zero exit on CRITICAL/HIGH findings only

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
        # INFORMATIONAL: Upload failures should not block the workflow
        # The actual security scan already passed/failed above
        continue-on-error: true
      - name: Upload security scan evidence
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: security-scan
          path: trivy-results.sarif

  evidence-pack:
    name: Release Evidence Pack
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs:
      - build-and-push-docker
      - benchmarks
      - security-scan
    permissions:
      contents: read
    env:
      PYTHON_VERSION: "3.11"
    outputs:
      evidence_archive: ${{ steps.archive.outputs.archive }}
      evidence_sha256: ${{ steps.archive.outputs.sha256 }}
      evidence_asset_name: ${{ steps.archive.outputs.asset_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"

      - name: Download benchmark logs
        uses: actions/download-artifact@v7
        with:
          name: benchmark-logs
          path: evidence-inputs

      - name: Download security scan artifacts
        uses: actions/download-artifact@v7
        with:
          name: security-scan
          path: evidence-inputs

      - name: Download release assets
        uses: actions/download-artifact@v7
        with:
          name: release-assets
          path: release-assets

      - name: Run coverage gate
        run: |
          set -o pipefail
          ./coverage_gate.sh 2>&1 | tee coverage-gate.log

      - name: Run unit tests with JUnit
        run: |
          mkdir -p reports
          set -o pipefail
          pytest tests/unit/ tests/state/ -q --tb=short --junitxml=reports/junit.xml 2>&1 | tee reports/unit-tests.log

      - name: Build artifact checksums
        id: checksums
        run: |
          mkdir -p artifacts
          {
            echo "docker_image_digest=${{ needs.build-and-push-docker.outputs.image_digest }}"
            sha256sum release-assets/sbom-cyclonedx.json
            sha256sum release-assets/sbom-spdx.json
            sha256sum release-assets/docs/openapi.json
          } > artifacts/artifact-checksums.txt

      - name: Capture evidence snapshot
        run: |
          cat > evidence-inputs.json <<'EOF'
          {
            "coverage_xml": "coverage.xml",
            "coverage_log": "coverage-gate.log",
            "junit_xml": "reports/junit.xml",
            "unit_log": "reports/unit-tests.log",
            "benchmark_log": "evidence-inputs/benchmark-output.log",
            "security_scan": "evidence-inputs/trivy-results.sarif",
            "artifact_checksums": "artifacts/artifact-checksums.txt"
          }
          EOF
          python scripts/evidence/capture_evidence.py --mode pack --inputs evidence-inputs.json

      - name: Locate evidence directory
        id: evidence_dir
        run: |
          set -euo pipefail
          DATE=$(date -u +%Y-%m-%d)
          TAG=${GITHUB_REF#refs/tags/}
          SHA=$(git rev-parse HEAD)
          echo "path=artifacts/evidence/${DATE}/${TAG}/${SHA}" >> "$GITHUB_OUTPUT"

      - name: Verify evidence snapshot
        run: |
          python scripts/evidence/verify_evidence_snapshot.py --evidence-dir "${{ steps.evidence_dir.outputs.path }}" --require-complete

      - name: Archive evidence pack
        id: archive
        run: |
          set -euo pipefail
          EVIDENCE_DIR="${{ steps.evidence_dir.outputs.path }}"
          TAG=${GITHUB_REF#refs/tags/}
          SHA=$(git rev-parse HEAD)
          ASSET_NAME="evidence-pack-${TAG}-${SHA}.tar.gz"
          tar -czf "${ASSET_NAME}" -C "${EVIDENCE_DIR}" .
          SHA256=$(sha256sum "${ASSET_NAME}" | awk '{print $1}')
          echo "archive=${ASSET_NAME}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "asset_name=${ASSET_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload evidence pack
        uses: actions/upload-artifact@v6
        with:
          name: release-evidence-pack
          path: ${{ steps.archive.outputs.archive }}

  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - build-and-push-docker
      - evidence-pack
    permissions:
      contents: write
    steps:
      - name: Download release assets
        uses: actions/download-artifact@v7
        with:
          name: release-assets
          path: release-assets

      - name: Download evidence pack
        uses: actions/download-artifact@v7
        with:
          name: release-evidence-pack
          path: .

      - name: Prepare release notes
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          SHA=${GITHUB_SHA}
          EVIDENCE_ASSET="${{ needs.evidence-pack.outputs.evidence_asset_name }}"
          EVIDENCE_HASH="${{ needs.evidence-pack.outputs.evidence_sha256 }}"
          EVIDENCE_LINK="https://github.com/${{ github.repository }}/releases/download/${TAG}/${EVIDENCE_ASSET}"
          cp release-assets/release-notes.md release-notes.md
          {
            echo ""
            echo "---"
            echo ""
            echo "**Evidence:** Attached / Verified"
            echo "- Evidence Pack: ${EVIDENCE_LINK}"
            echo "- Evidence SHA256: \`${EVIDENCE_HASH}\`"
            echo "- Commit SHA: \`${SHA}\`"
          } >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes.md
          files: |
            ${{ needs.evidence-pack.outputs.evidence_archive }}
            release-assets/sbom-cyclonedx.json
            release-assets/sbom-spdx.json
            release-assets/docs/openapi.json
            release-assets/changelog-fragment.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Post-deploy smoke test (minimal healthy endpoint check)
  post-deploy-smoke:
    name: Post-deploy Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - build-and-push-docker
      - security-scan

    steps:
      - name: Smoke test healthy endpoint
        env:
          HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
        run: |
          if [ -z "$HEALTHCHECK_URL" ]; then
            echo "HEALTHCHECK_URL secret is not set."
            exit 1
          fi

          echo "Checking health endpoint: $HEALTHCHECK_URL"
          curl --fail --silent --show-error \
            --retry 5 \
            --retry-delay 5 \
            --retry-all-errors \
            "$HEALTHCHECK_URL"

  # Rollback if smoke tests fail
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: post-deploy-smoke
    if: failure()

    steps:
      - name: Trigger rollback
        run: |
          echo "Smoke tests failed. Triggering rollback."
          echo "Rollback should be executed by the deployment system."

      - name: Record rollback in release log
        run: |
          cat <<'EOF' > release-rollback-log.md
          # Release Rollback

          Smoke tests failed after deployment.

          - Tag: ${GITHUB_REF#refs/tags/}
          - Workflow: $GITHUB_WORKFLOW
          - Run ID: $GITHUB_RUN_ID
          - Timestamp (UTC): $(date -u +%Y-%m-%dT%H:%M:%SZ)
          EOF

          cat release-rollback-log.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload rollback log
        uses: actions/upload-artifact@v6
        with:
          name: release-rollback-log
          path: release-rollback-log.md
          retention-days: 30
