name: Security - SAST Scan

# Static Application Security Testing (SAST) workflow
# Runs Bandit for Python security analysis on PRs and pushes

on:
  push:
    branches:
      - main
      - 'feature/*'
  pull_request:
    branches:
      - main
      - 'feature/*'

permissions:
  contents: read
  security-events: write

jobs:
  bandit-scan:
    name: Bandit Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]
      
      - name: Run Bandit scan
        run: |
          # Run Bandit with SARIF output for GitHub Security tab
          bandit -r src/ \
            -c pyproject.toml \
            --severity-level medium \
            --confidence-level medium \
            -f sarif \
            -o bandit-results.sarif \
            --exit-zero
      
      - name: Upload Bandit SARIF results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-results.sarif
          category: bandit
        if: always()
      
      - name: Run Bandit with console output
        run: |
          # Also run with console output for PR review
          bandit -r src/ \
            -c pyproject.toml \
            --severity-level medium \
            --confidence-level medium \
            -f txt \
            -o bandit-report.txt || true
          
          echo "=== Bandit Scan Results ==="
          cat bandit-report.txt
          
          # Fail on high severity issues
          bandit -r src/ \
            -c pyproject.toml \
            --severity-level high \
            --confidence-level high
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: |
            bandit-results.sarif
            bandit-report.txt
          retention-days: 30
        if: always()

  semgrep-scan:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/python
            p/security-audit
            p/secrets
          generateSarif: true
        continue-on-error: true
      
      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: semgrep
        if: always()
