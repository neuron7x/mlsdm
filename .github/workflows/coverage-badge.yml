name: Update Coverage Badge

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: coverage-badge-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Increased from 20min to accommodate 1500s coverage timeout + overhead
    if: github.repository_owner == 'neuron7x' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
    env:
      PYTHONHASHSEED: "0"
      PYTHONUTF8: "1"
      PYTHONIOENCODING: "utf-8"
      DISABLE_RATE_LIMIT: "1"
      LLM_BACKEND: "local_stub"
      COVERAGE_SOFT_LIMIT_SECONDS: "1500"  # Increased from 1020s to provide 35% safety buffer (historical: 1109s needed)

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml
            uv.lock

      - name: Capture Python version
        run: |
          python - <<'PY'
          import os
          import sys
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env_file:
              env_file.write(f"PYTHON_VERSION={sys.version}\n")
          PY

      - name: Inspect pip cache
        run: |
          if [ -d "${HOME}/.cache/pip" ]; then
            echo "PIP_CACHE_PRESENT=true" >> "$GITHUB_ENV"
          else
            echo "PIP_CACHE_PRESENT=false" >> "$GITHUB_ENV"
          fi
          python -m pip cache info || true

      - name: Install dependencies
        run: |
          install_start=$(date +%s)
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e ".[test]"
          pip install coverage-badge
          install_end=$(date +%s)
          echo "INSTALL_DURATION_SECONDS=$((install_end - install_start))" >> "$GITHUB_ENV"

      - name: Verify test dependencies
        run: python -c "import hypothesis, pytest, pytest_benchmark"

      - name: Run coverage
        run: scripts/ci/run_coverage.sh

      - name: Generate badge
        if: success()
        run: |
          badge_start=$(date +%s)
          coverage-badge -o coverage.svg -f
          badge_end=$(date +%s)
          echo "BADGE_DURATION_SECONDS=$((badge_end - badge_start))" >> "$GITHUB_ENV"

      - name: Verify badge generation
        if: success()
        run: |
          if [ ! -f coverage.svg ]; then
            echo "ERROR: coverage.svg was not generated"
            exit 1
          fi
          echo "âœ“ coverage.svg exists ($(stat -c%s coverage.svg 2>/dev/null || stat -f%z coverage.svg) bytes)"

      - name: Update evidence report
        if: always()
        run: |
          python <<'PY'
          import json
          import os
          import pathlib

          report_path = pathlib.Path("artifacts/evidence/coverage_badge_run_report.json")
          report_path.parent.mkdir(parents=True, exist_ok=True)

          data = {}
          if report_path.exists():
              data = json.loads(report_path.read_text())

          data["commit"] = os.environ.get("GITHUB_SHA", data.get("commit", "unknown"))
          data["python_version"] = os.environ.get("PYTHON_VERSION", data.get("python_version", "unknown"))
          data.setdefault("durations", {})
          data["durations"]["install_seconds"] = int(os.environ.get("INSTALL_DURATION_SECONDS", "0") or 0)
          data["durations"]["badge_seconds"] = int(os.environ.get("BADGE_DURATION_SECONDS", "0") or 0)
          data.setdefault("cache_hits", {})
          data["cache_hits"]["pip_cache_present"] = os.environ.get("PIP_CACHE_PRESENT", "false") == "true"
          data["canceled_flag"] = os.environ.get("CANCELED_FLAG", "false") == "true"

          report_path.write_text(json.dumps(data, indent=2, sort_keys=True))
          PY

      - name: Write evidence summary
        if: always()
        run: |
          python <<'PY'
          import json
          import os
          import pathlib
          report_path = pathlib.Path("artifacts/evidence/coverage_badge_run_report.json")
          if not report_path.exists():
              print("Evidence report not found.")
              raise SystemExit(0)
          data = json.loads(report_path.read_text())
          summary = [
              "## Coverage Badge Evidence",
              f"- Commit: {data.get('commit')}",
              f"- Python: {data.get('python_version')}",
              f"- Coverage: {data.get('coverage_value')}",
              f"- Coverage exit code: {data.get('exit_codes', {}).get('coverage')}",
              f"- Durations (s): {data.get('durations')}",
              f"- Cache hits: {data.get('cache_hits')}",
              f"- Canceled: {data.get('canceled_flag')}",
          ]
          summary_path = os.environ.get("GITHUB_STEP_SUMMARY")
          if summary_path:
              with open(summary_path, "a", encoding="utf-8") as summary_file:
                  summary_file.write("\n".join(summary) + "\n")
          PY

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge-artifacts-${{ github.run_id }}
          path: |
            coverage.xml
            coverage.json
            .coverage
            coverage.svg
            artifacts/evidence/**
          if-no-files-found: warn

  publish-badge:
    runs-on: ubuntu-latest
    needs: coverage
    if: github.repository_owner == 'neuron7x' && github.ref == 'refs/heads/main' && needs.coverage.result == 'success' && !cancelled()
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download badge artifact
        uses: actions/download-artifact@v4.1.3
        with:
          name: coverage-badge-artifacts-${{ github.run_id }}
          path: artifacts/download

      - name: Commit badge to badges branch
        run: |
          set -euo pipefail

          if [ ! -f artifacts/download/coverage.svg ]; then
            echo "ERROR: coverage.svg missing from artifacts."
            exit 1
          fi

          mkdir -p /tmp/mlsdm-badges
          cp artifacts/download/coverage.svg /tmp/mlsdm-badges/coverage.svg

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin badges || true
          if git show-ref --verify --quiet refs/remotes/origin/badges; then
            git checkout -B badges origin/badges
          else
            git checkout --orphan badges
            git rm -rf . || true
          fi

          cp /tmp/mlsdm-badges/coverage.svg coverage.svg

          git add coverage.svg
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: update coverage badge [skip ci]"
          git push origin badges
